presubmits:
  - name: pull-configs-validate-prow-yaml
    decorate: true
    run_if_changed: 'prow/'
    branches:
      - ^main$
    spec:
      containers:
        - image: gcr.io/k8s-prow/checkconfig:v20201204-d90be1ef6b
          command:
            - /checkconfig
          args:
            - --plugin-config=prow/config/plugins.yaml
            - --config-path=prow/config/config.yaml
  - name: pull-configs-validate-labels-yaml
    decorate: true
    run_if_changed: 'prow/config/labels.yaml'
    branches:
      - ^main$
    spec:
      containers:
        - image: gcr.io/k8s-prow/label_sync:v20201204-d90be1ef6b
          command:
            - /app/label_sync/app.binary
          args:
            - --config=prow/config/labels.yaml
            - --confirm=false
            - --only=tidb-community-bots/ti-community-prow,tidb-community-bots/configs,tidb-community-bots/ti-community-bot,tidb-community-bots/ti-challenge-bot,pingcap/community,tikv/community,tikv/pd
            - --token=/etc/github/token
          volumeMounts:
            - name: github-token
              mountPath: /etc/github
              readOnly: true
      volumes:
        - name: github-token
          secret:
            secretName: github-token
postsubmits:
  - name: post-configs-update-orgs
    decorate: true
    run_if_changed: 'orgs/'
    branches:
      - ^main$
    max_concurrency: 1
    spec:
      containers:
        - image: golang:1.15
          command:
            - scripts/peribolos.sh
          args:
            - --config-path=orgs/config.yaml
            - --github-token-path=/etc/github/token
            - --github-endpoint=http://ghproxy
            - --github-endpoint=https://api.github.com
            - --min-admins=2
            - --fix-org
            - --fix-org-members
            - --fix-teams
            - --fix-team-members
            - --fix-team-repos
            - --tokens=1200
            - --confirm
          volumeMounts:
            - name: github-token
              mountPath: /etc/github
              readOnly: true
      volumes:
        - name: github-token
          secret:
            secretName: github-token
  - name: post-configs-deploy-prow
    run_if_changed: 'prow/cluster'
    decorate: true
    branches:
      - ^main$
    max_concurrency: 1
    spec:
      containers:
        - image: google/cloud-sdk:319.0.0
          command:
            - scripts/deploy.sh
          args:
            - --confirm
            - --config=trusted
          env:
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /creds/service-account.json
          volumeMounts:
            - name: creds
              mountPath: /creds
      volumes:
        - name: creds
          secret:
            secretName: deployer-credentials
    annotations:
      description: deploys the configured version of prow by running scripts/deploy.sh
  - name: post-configs-label-sync
    decorate: true
    run_if_changed: 'prow/config/labels.yaml'
    branches:
      - ^main$
    spec:
      containers:
        - image: gcr.io/k8s-prow/label_sync:v20201204-d90be1ef6b
          command:
            - /app/label_sync/app.binary
          args:
            - --config=prow/config/labels.yaml
            - --confirm=true
            - --only=tidb-community-bots/ti-community-prow,tidb-community-bots/configs,tidb-community-bots/ti-community-bot,tidb-community-bots/ti-challenge-bot,pingcap/community,tikv/community,tikv/pd
            - --token=/etc/github/token
          volumeMounts:
            - name: github-token
              mountPath: /etc/github
              readOnly: true
      volumes:
        - name: github-token
          secret:
            secretName: github-token