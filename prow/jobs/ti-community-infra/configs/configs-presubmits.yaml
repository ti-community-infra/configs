presubmits:
  ti-community-infra/configs:
    - name: pull-configs-validate-prow-yaml
      decorate: true
      run_if_changed: 'prow/'
      branches:
        - ^main$
      spec:
        containers:
          - image: gcr.io/k8s-prow/checkconfig:v20210323-4a95c1446c
            command:
              - /checkconfig
            args:
              - --plugin-config=prow/config/plugins.yaml
              - --config-path=prow/config/config.yaml
              - --job-config-path=prow/jobs
    - name: pull-configs-validate-external-plugin-yaml
      decorate: true
      run_if_changed: 'prow/config/external_plugins_config.yaml'
      branches:
        - ^main$
      spec:
        containers:
          - image: ticommunityinfra/tichi-check-external-plugin-config:v1.5.1
            command:
              - check-external-plugin-config
            args:
              - --external-plugin-config-path=prow/config/external_plugins_config.yaml
    - name: pull-configs-validate-labels-yaml
      decorate: true
      run_if_changed: 'prow/config/labels.yaml'
      branches:
        - ^main$
      spec:
        containers:
          - image: gcr.io/k8s-prow/label_sync:v20210323-4a95c1446c
            command:
              - /app/label_sync/app.binary
            args:
              - --config=prow/config/labels.yaml
              - --confirm=false
              - --only=ti-community-infra/tichi,ti-community-infra/configs,ti-community-infra/ti-community-bot,ti-community-infra/ti-challenge-bot,ti-community-infra/ti-sync-bot,ti-community-infra/rfcs,ti-community-infra/devstats,ti-community-infra/devstats-dev-guide,pingcap/community,pingcap/docs,pingcap/docs-cn,pingcap/docs-dm,pingcap/docs-tidb-operator,tikv/community,tikv/pd
              - --token=/etc/github/token
            volumeMounts:
              - name: github-token
                mountPath: /etc/github
                readOnly: true
        volumes:
          - name: github-token
            secret:
              secretName: github-token
    - name: pull-configs-validate-orgs
      decorate: true
      run_if_changed: 'orgs/'
      branches:
        - ^main$
      max_concurrency: 1
      spec:
        containers:
          - image: golang:1.15
            command:
              - scripts/peribolos.sh
            args:
              - --config-path=orgs/config.yaml
              - --github-token-path=/etc/github/token
              - --github-endpoint=http://ghproxy
              - --github-endpoint=https://api.github.com
              - --min-admins=2
              - --fix-org
              - --fix-org-members
              - --fix-teams
              - --fix-team-members
              - --fix-team-repos
              - --tokens=1200
              - --confirm=false
            volumeMounts:
              - name: github-token
                mountPath: /etc/github
                readOnly: true
        volumes:
          - name: github-token
            secret:
              secretName: github-token